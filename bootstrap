#!/bin/bash
#
#   For brand new AWS accounts, this script will configure the account alias
#   prior to applying Terraform. It will exit if the state bucket already
#   exists.
#
set -e -o pipefail

usage() {
    echo "Usage: $0 <account-alias> <region>"
    exit 1
}
[[ -z $1 || -z $2 ]] && usage
set -u

readonly account_alias=$1
readonly region=$2

readonly state_bucket=${account_alias}-terraform-state-${region}
readonly logging_bucket=${account_alias}-terraform-state-logs-${region}
readonly tfvars_file=terraform.tfvars

# If you are running this with aws-vault and using sessions so you can
# assume roles cross-account with MFA enabled you will want to run an
# arbitrary aws command to instanstiate a session before we need to examine output.
if [[ -z "${AWS_VAULT_NO_SESSION+x}" || "${AWS_VAULT_NO_SESSION}" != "true" ]]; then
    aws s3 ls
fi

bucket_exists() {
    bucket=$1
    output=$(aws s3 ls "s3://$bucket/" 2>&1)
    exit_code="$?"
    status=$(echo "$output" | grep -o 'bucket does not exist') || true
    if [[ -z "$status" && "$exit_code" -gt 0 ]]; then
        echo "$output"
        exit 1
    fi
    [[ $status != 'bucket does not exist' ]]
}

# Bail out if the state bucket already exists
if bucket_exists "$state_bucket"; then
    set +x
    echo -e '\nLooks like the bucket '"$state_bucket"' already exists!'
    exit 1
fi

# Bail out if the logging bucket already exists
if bucket_exists "$logging_bucket"; then
    set +x
    echo -e '\nLooks like the bucket '"$logging_bucket"' already exists!'
    exit 1
fi

current_alias=$(aws iam list-account-aliases --query 'AccountAliases' --output text)
if [[ -z $current_alias ]]; then
    echo "Setting account alias to $account_alias"
    aws iam create-account-alias --account-alias "$account_alias"
elif [[ $current_alias != "$account_alias" ]]; then
    echo "Current alias '$current_alias' does not match '$account_alias'!"
    exit 1
fi

# Generate terraform.tfvars with user settings
rm -f $tfvars_file
{
    echo "region = \"$region\""
    echo "state_bucket = \"$state_bucket\""
    echo "logging_bucket = \"$logging_bucket\""
} >> $tfvars_file
terraform fmt $tfvars_file > /dev/null

# Create resources
terraform init
terraform apply -auto-approve

# Save the region and local state
git add "$tfvars_file" terraform.tfstate
git commit -m "Bootstrapped Terraform remote state setup"

echo
echo
echo "To complete the bootstrap process, push these changes to your repo!"
